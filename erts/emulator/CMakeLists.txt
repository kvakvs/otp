project(emulator CXX C ASM)
cmake_minimum_required(VERSION 2.8)
#aux_source_directory(. SRC_LIST)

find_package (Threads)

set(CXX clang++)
set(CC  clang)
set(EMU_PLATF_TRIPLET "x86_64-unknown-linux-gnu")
set(EMU_PLATF_OS "unix") # unix ose or win32
set(EMU_SMP "smp") # smp or plain
set(HIPE_ARCH amd64)

set(emulator_PLATF_opt_SMP  ${CMAKE_SOURCE_DIR}/${EMU_PLATF_TRIPLET}/opt/${EMU_SMP})
set(emulator_PLATF          ${CMAKE_SOURCE_DIR}/${EMU_PLATF_TRIPLET})

include_directories( ${CMAKE_SOURCE_DIR}
    ${CMAKE_SOURCE_DIR}/beam
    ${CMAKE_SOURCE_DIR}/hipe
    ${CMAKE_SOURCE_DIR}/pcre
    ${CMAKE_SOURCE_DIR}/drivers/common
    ${CMAKE_SOURCE_DIR}/sys/common
    ${CMAKE_SOURCE_DIR}/sys/${EMU_PLATF_OS}
    ${CMAKE_SOURCE_DIR}/../include
    ${CMAKE_SOURCE_DIR}/../include/internal
    ${CMAKE_SOURCE_DIR}/../include/${EMU_PLATF_TRIPLET}
    ${CMAKE_SOURCE_DIR}/../${EMU_PLATF_TRIPLET}
    ${CMAKE_SOURCE_DIR}/${EMU_PLATF_TRIPLET}
    ${CMAKE_SOURCE_DIR}/${EMU_PLATF_TRIPLET}/opt/${EMU_SMP}
    )

add_definitions(-DHAVE_CONFIG_H
    -DERTS_SMP
    -DUSE_THREADS -DETHR_PTHREADS
    -D_GNU_SOURCE=1
    -DERLANG_INTEGRATION
    -DLIBSCTP=libsctp.so.1
    -O3
    )
set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS}
    -std=c++11
    )
set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS}
    -std=c99
    )
set(SRC_BLOATWARE
    bloatware/include/bw_types.h
    )
set(SRC_GENERATED
    # generated by otp build
    #======================================================
    ${emulator_PLATF_opt_SMP}/erl_alloc_types.h
    bloatware/gen/beam_opcodes.cpp      bloatware/gen/beam_opcodes.h
    bloatware/gen/driver_tab.cpp
    ${emulator_PLATF}/erl_atom_table.c      ${emulator_PLATF}/erl_atom_table.h
    bloatware/gen/erl_bif_wrap.cpp
    ${emulator_PLATF}/preload.c
    #${emulator_PLATF}/erl_bif_table.cpp
    bloatware/gen/erl_bif_table.cpp
    )
set(SRC_LIST
    beam/atom.cpp               beam/atom.h
    beam/beam_bif_load.cpp
    beam/beam_bp.cpp            beam/beam_bp.h
    beam/beam_catches.cpp       beam/beam_catches.h
    beam/beam_debug.cpp
    beam/beam_emu.cpp
    beam/beam_load.cpp          beam/beam_load.h
    beam/beam_ranges.cpp
    beam/benchmark.cpp          beam/benchmark.h
    beam/bif.cpp                beam/bif.h
    beam/big.cpp                beam/big.h
    beam/binary.cpp
    beam/break.cpp
    beam/code_ix.cpp            beam/code_ix.h
    beam/copy.cpp
    beam/dist.cpp               beam/dist.h
    beam/erl_afit_alloc.cpp     beam/erl_afit_alloc.h
    beam/erl_alloc.cpp          beam/erl_alloc.h
    beam/erl_alloc_util.cpp     beam/erl_alloc_util.h
    beam/erl_ao_firstfit_alloc.cpp   beam/erl_ao_firstfit_alloc.h
    beam/erl_arith.cpp
    beam/erl_async.cpp          beam/erl_async.h
    beam/erl_bestfit_alloc.cpp  beam/erl_bestfit_alloc.h
    beam/erl_bif_binary.cpp
    beam/erl_bif_chksum.cpp
    beam/erl_bif_ddll.cpp
    beam/erl_bif_info.cpp
    beam/erl_bif_op.cpp
    beam/erl_bif_guard.cpp
    beam/erl_bif_lists.cpp
    beam/erl_bif_os.cpp
    beam/erl_bif_port.cpp
    beam/erl_bif_re.cpp
    beam/erl_bif_timer.cpp      beam/erl_bif_timer.h
    beam/erl_bif_trace.cpp
    beam/erl_bits.cpp           beam/erl_bits.h
      beam/erl_binary.h
    beam/erl_cpu_topology.cpp   beam/erl_cpu_topology.h
    beam/erl_db.cpp             beam/erl_db.h
    beam/erl_db_hash.cpp        beam/erl_db_hash.h
    beam/erl_db_tree.cpp        beam/erl_db_tree.h
    beam/erl_db_util.cpp        beam/erl_db_util.h
      beam/erl_driver.h
    beam/erl_drv_thread.cpp
    beam/erl_fun.cpp            beam/erl_fun.h
    beam/erl_gc.cpp             beam/erl_gc.h
    beam/erl_goodfit_alloc.cpp  beam/erl_goodfit_alloc.h
    beam/erl_init.cpp
    beam/erl_instrument.cpp     beam/erl_instrument.h
    beam/erl_map.cpp            beam/erl_map.h
    beam/erl_math.cpp
    beam/erl_md5.cpp
    beam/erl_message.cpp        beam/erl_message.h
    beam/erl_monitors.cpp       beam/erl_monitors.h
    beam/erl_mtrace.cpp         beam/erl_mtrace.h
    beam/erl_nif.cpp            beam/erl_nif.h
    beam/erl_node_tables.cpp    beam/erl_node_tables.h
      beam/erl_port.h
    beam/erl_port_task.cpp      beam/erl_port_task.h
    beam/erl_posix_str.cpp
    beam/erl_printf_term.cpp    beam/erl_printf_term.h
    beam/erl_process.cpp        beam/erl_process.h
    beam/erl_process_dict.cpp   beam/erl_process_dict.h
    beam/erl_process_dump.cpp
    beam/erl_process_lock.cpp   beam/erl_process_lock.h
    beam/erl_ptab.cpp           beam/erl_ptab.h
    beam/erl_sched_spec_pre_alloc.cpp beam/erl_sched_spec_pre_alloc.h
      beam/erl_smp.h
    beam/erl_term.cpp           beam/erl_term.h
      beam/erl_threads.h
    beam/erl_thr_progress.cpp   beam/erl_thr_progress.h
    beam/erl_thr_queue.cpp      beam/erl_thr_queue.h
      beam/erl_thr_queue.h
      beam/erl_time.h
    beam/erl_time_sup.cpp
    beam/erl_trace.cpp          beam/erl_trace.h
    beam/erl_unicode.cpp        beam/erl_unicode.h
    beam/erl_zlib.cpp           beam/erl_zlib.h
      beam/erl_utils.h
    beam/export.cpp             beam/export.h
    beam/external.cpp           beam/external.h
      beam/global.h
    beam/hash.cpp               beam/hash.h
    beam/index.cpp              beam/index.h
    beam/io.cpp
    beam/module.cpp             beam/module.h
    beam/packet_parser.cpp      beam/packet_parser.h
    beam/register.cpp           beam/register.h
    beam/safe_hash.cpp          beam/safe_hash.h
      beam/sys.h
    beam/time.cpp
    beam/utils.cpp

    #======================================================
    drivers/common/efile_drv.cpp
        drivers/common/erl_efile.h
    drivers/common/gzio.cpp     drivers/common/gzio.h
    drivers/common/inet_drv.cpp
    drivers/common/ram_file_drv.cpp
    drivers/common/zlib_drv.cpp

    drivers/unix/ttsl_drv.cpp
    drivers/unix/unix_efile.cpp

    #======================================================
    #hipe/hipe_${HIPE_ARCH}.cpp
    #hipe/hipe_${HIPE_ARCH}_glue.S
    #${emulator_PLATF_opt_SMP}/hipe_${HIPE_ARCH}_bifs.S
    #${emulator_PLATF_opt_SMP}/hipe_${HIPE_ARCH}_asm.h
    #${emulator_PLATF_opt_SMP}/hipe_literals.h
    #${emulator_PLATF_opt_SMP}/hipe_x86_asm.h

    #hipe/hipe_bif0.cpp            hipe/hipe_bif0.h
    #hipe/hipe_bif1.cpp            hipe/hipe_bif1.h
    #hipe/hipe_bif2.cpp
    #hipe/hipe_bif64.cpp           hipe/hipe_bif64.h
    #hipe/hipe_debug.cpp           hipe/hipe_debug.h
    #hipe/hipe_gc.cpp              hipe/hipe_gc.h
    #hipe/hipe_mode_switch.cpp     hipe/hipe_mode_switch.h
    #hipe/hipe_native_bif.cpp      hipe/hipe_native_bif.h
    #  hipe/hipe_process.h
    #hipe/hipe_x86_signal.cpp
    #hipe/hipe_x86_stack.cpp
    #hipe/hipe_stack.cpp           hipe/hipe_stack.h

    #======================================================
    #pcre/dftables.c
    pcre/local_config.h
    pcre/pcre.h
    pcre/pcre_byte_order.c
    pcre/pcre_chartables.c
    pcre/pcre_compile.c
    pcre/pcre_config.c
    pcre/pcre_dfa_exec.c
    pcre/pcre_exec.c
    pcre/pcre_fullinfo.c
    pcre/pcre_get.c
    pcre/pcre_globals.c
    pcre/pcre_internal.h
    pcre/pcre_jit_compile.c
    #pcre/pcre_latin_1_table.c
    pcre/pcre_maketables.c
    pcre/pcre_newline.c
    pcre/pcre_ord2utf8.c
    pcre/pcre_refcount.c
    pcre/pcre_string_utils.c
    pcre/pcre_study.c
    pcre/pcre_tables.c
    pcre/pcre_ucd.c
    pcre/pcre_valid_utf8.c
    pcre/pcre_version.c
    pcre/pcre_xclass.c
    pcre/ucp.h

    #======================================================
    sys/common/erl_check_io.kp.cpp
    sys/common/erl_check_io.nkp.cpp       sys/common/erl_check_io.h
    sys/common/erl_mmap.cpp               sys/common/erl_mmap.h
    sys/common/erl_mtrace_sys_wrap.cpp
    sys/common/erl_mseg.cpp               sys/common/erl_mseg.h
    sys/common/erl_poll.kp.cpp
    sys/common/erl_poll.nkp.cpp           sys/common/erl_poll.h
    sys/common/erl_sys_common_misc.cpp

    sys/${EMU_PLATF_OS}/erl_main.cpp
      sys/${EMU_PLATF_OS}/erl_unix_sys.h
    sys/${EMU_PLATF_OS}/erl_unix_sys_ddll.cpp
    sys/${EMU_PLATF_OS}/sys.cpp
    sys/${EMU_PLATF_OS}/sys_float.cpp
    sys/${EMU_PLATF_OS}/sys_time.cpp

    #======================================================
    zlib/adler32.c
    zlib/compress.c
    zlib/crc32.c            zlib/crc32.h
    zlib/deflate.c          zlib/deflate.h
        zlib/gzguts.h
    zlib/inffast.c          zlib/inffast.h
        zlib/inffixed.h
    zlib/inflate.c          zlib/inflate.h
    zlib/inftrees.c         zlib/inftrees.h
    zlib/trees.c            zlib/trees.h
    zlib/uncompr.c
    zlib/zconf.h
    zlib/zlib.h
    zlib/zutil.c            zlib/zutil.h

    #======================================================
    ../${EMU_PLATF_TRIPLET}/config.h

    ../lib_src/common/erl_misc_utils.cpp ../include/internal/erl_misc_utils.h
    ../lib_src/common/erl_printf.cpp
    ../lib_src/common/erl_printf_format.cpp
    ../lib_src/common/ethr_atomics.cpp
    ../lib_src/common/ethr_mutex.cpp
    ../lib_src/common/ethr_aux.cpp
    ../lib_src/pthread/ethread.cpp    ../include/internal/ethread.h
    ../lib_src/pthread/ethr_event.cpp
    ../include/internal/ethread_inline.h
    )

add_executable(${PROJECT_NAME} ${SRC_LIST} ${SRC_GENERATED} ${SRC_BLOATWARE})
#SET_SOURCE_FILES_PROPERTIES(${SRC_GENERATED} PROPERTIES LANGUAGE CXX )

target_link_libraries(${PROJECT_NAME} ${CMAKE_THREAD_LIBS_INIT}
                      m dl curses pthread)
